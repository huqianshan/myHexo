---
title: 用户态驱动概述
date: 2020-05-16 09:39:02
tags:
- [Linux]
- [Driver]
---

## 概述

## User Space Drivers in Linux

### `uio`

- uio exposes `all necessary interfaces` to write full user space
drivers via `memory mapping files` in the `sysfs` pseudo filesystem.

- These file-based APIs give us full access to the device
without needing to write any kernel code.

### `vfio`

- vfio offers more features: `IOMMU` and `interrupts` are only
supported with vfio

- these features come at the
cost of additional complexity: It requires `binding the PCIe`
device to the generic `vfio-pci driver` and it then exposes
an API via `ioctl syscalls` on special files.

> - The driver can initiate an access to the device’s `Base
Address Registers (BARs)` or the device can initiate a `direct
memory access (DMA)` to access arbitrary main memory locations.
> - BARs are used by the device to expose configuration
and control registers to the drivers. 
> - These registers are available
either via memory mapped IO (MMIO) or via x86 IO
ports depending on the device, the latter way of exposing
them is deprecated in PCIe.

## 案例说明

### 用户态的网卡驱动设备

#### `DPDK`

![DPDK](http://www.cnbigcloud.com/wp-content/uploads/2019/07/dpdk01.png)

##### DPDK架构

左边是原来的方式数据从 网卡 -> 驱动 -> 协议栈 -> Socket接口 -> 业务

右边是DPDK的方式，基于UIO（Userspace I/O）旁路数据。数据从 网卡 -> DPDK轮询模式-> DPDK基础库 -> 业务

用户态的好处是易用开发和维护，灵活性好。并且Crash也不影响内核运行，鲁棒性强。

DPDK支持的CPU体系架构：x86、ARM、PowerPC（PPC）

DPDK支持的网卡列表：[click here](https://core.dpdk.org/supported/)，我们主流使用Intel 82599（光口）、Intel x540（电口)

##### DPDK 核心设计

- 用户态驱动程序，基于UIO

- PMD(Poll Mode Driver) DPDK的UIO驱动屏蔽了硬件发出中断，然后在用户态采用主动轮询的方式.

- UIO旁路了内核，主动轮询去掉硬中断，DPDK从而可以在用户态做收发包处理。带来Zero Copy、无系统调用的好处，同步处理减少上下文切换带来的Cache Miss。

- 运行在PMD的Core会处于用户态CPU100%的状态.网络空闲时CPU长期空转，会带来能耗问题。所以，DPDK推出Interrupt DPDK模式。


##### DPDK 对比

DPDK still uses a small kernel module
with some drivers, but it does not contain driver logic and
is only used during initialization.

The downside is the poor
integration with the kernel, DPDK’s KNI (kernel network
interface) needs to copy packets to pass them to the kernel
unlike XDP or netmap which can just pass a pointer.

Other
advantages of DPDK are its support in the industry, mature
code base, and large community.DPDK supports virtually
all NICs commonly found in servers

#### `netmap`

a standard component in FreeBSD and also available
on Linux) offers interfaces to pass packets between the
kernel network stack and a user space app, it can even make
use of the kernel’s TCP/IP stack with StackMap

- 需要驱动支持，需要网卡厂商认可方案

- 依赖中断通知机制，未完全解决瓶颈

- 像是系统调用，实现用户态收发包，功能原始，没有网络开发框架，社区不完善


